# SecretProviderClass: AWS Secrets Manager와 Kubernetes Secret을 연동하는 리소스
# CSI (Container Storage Interface) Driver를 사용하여 자동으로 Secret 생성
apiVersion: secrets-store.csi.x-k8s.io/v1  # CSI Driver API 버전
kind: SecretProviderClass                   # 리소스 타입
metadata:
  name: fproject-backend-secrets  # SecretProviderClass 이름
  namespace: default              # 배포할 네임스페이스
spec:
  provider: aws
  parameters:
    # AWS Secrets Manager에서 가져올 비밀 목록
    objects: |
      # RDS 자격증명 (one-rds-credentials)
      # JSON 구조: {"dbname":"onedb","username":"oneuser","password":"test1234","host":"...","port":5432}
      - objectName: "one-rds-credentials"      # Secrets Manager의 비밀 이름
        objectType: "secretsmanager"           # 타입 (secretsmanager/parameter)
        jmesPath:                              # JSON 파싱 경로
          - path: password                     # JSON의 "password" 필드 추출
            objectAlias: DB_PASSWORD           # Kubernetes Secret의 키 이름
      # AWS 자격증명 (one-aws-credentials)
      # JSON 구조: {"access_key_id":"AKIA...","secret_access_key":"xM/..."}
      - objectName: "one-aws-credentials"
        objectType: "secretsmanager"
        jmesPath:
          - path: access_key_id
            objectAlias: AWS_ACCESS_KEY_ID
          - path: secret_access_key
            objectAlias: AWS_SECRET_ACCESS_KEY
  # Kubernetes Secret 자동 생성 설정
  secretObjects:
  - secretName: fproject-backend-secret  # 생성될 Secret 이름 (Deployment에서 참조)
    type: Opaque                         # Secret 타입 (Opaque = 일반 Secret)
    data:                                # Secret에 저장될 데이터
    - objectName: DB_PASSWORD            # 위에서 정의한 objectAlias
      key: DB_PASSWORD                   # Secret의 키 이름
    - objectName: AWS_ACCESS_KEY_ID
      key: AWS_ACCESS_KEY_ID
    - objectName: AWS_SECRET_ACCESS_KEY
      key: AWS_SECRET_ACCESS_KEY
# 참고: GOOGLE_CLIENT_SECRET은 AWS Secrets Manager에 없으므로 제외
# 필요하면 journal-api/google-oauth 비밀을 Secrets Manager에 생성해야 함
# 동작 방식:
# 1. Pod 시작 시 CSI Driver가 이 설정을 읽음
# 2. ServiceAccount의 IAM Role로 Secrets Manager에 접근
# 3. 비밀을 가져와서 Kubernetes Secret 자동 생성
# 4. Deployment가 이 Secret을 환경변수로 주입
